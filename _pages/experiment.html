---
layout: single
title: "Experiment"
permalink: /experiment/
author_profile: true
---

<style>
body {
    overflow: auto;
}

.experiment-container {
    text-align: center;
    max-width: 800px;
    margin: 30px auto;
    padding: 30px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.button {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 15px 30px;
    margin: 20px 0;
    font-size: 18px;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: inline-block;
    text-decoration: none;
}

.button:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.green-button {
    background-color: #2ecc71;
}

.green-button:hover {
    background-color: #27ae60;
}

#status-message {
    margin: 20px 0;
    padding: 10px;
    font-style: italic;
    color: #666;
}

#result-container {
    margin: 20px 0;
    padding: 15px;
    border: 2px dashed #3498db;
    border-radius: 6px;
    background-color: #f0f8ff;
    text-align: left;
    display: none;
}

.result-link {
    word-break: break-all;
    display: block;
    margin: 10px 0;
    color: #3498db;
    font-weight: bold;
}

#error-message {
    margin: 20px 0;
    padding: 10px;
    color: #e74c3c;
    background-color: #fadbd8;
    border-radius: 4px;
    font-weight: bold;
    display: none;
}

.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0,0,0,0.1);
    border-radius: 50%;
    border-top-color: #3498db;
    animation: spin 1s ease-in-out infinite;
    margin-left: 10px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<div class="experiment-container">
    <h2>oTree Experiment Session Link Generator</h2>
    
    <p>Click the button below to generate a new session link for the oTree experiment:</p>
    
    <button id="generate-button" class="button">Generate Session Link</button>
    
    <div id="status-message"></div>
    
    <div id="error-message"></div>
    
    <div id="result-container">
        <h3>Your Session Link:</h3>
        <a id="result-link" href="#" target="_blank" class="result-link"></a>
        <button id="open-button" class="button green-button">Open in New Tab</button>
    </div>
</div>

<script type="text/javascript">
(function() {
    // Глобальная переменная для хранения найденной ссылки
    var sessionUrl = '';
    
    // Функция для установки статуса
    function setStatus(message, loading) {
        var statusElement = document.getElementById('status-message');
        
        if (statusElement) {
            if (loading) {
                statusElement.innerHTML = message + ' <span class="spinner"></span>';
            } else {
                statusElement.textContent = message;
            }
        }
    }
    
    // Функция для отображения ошибки
    function showError(message) {
        var errorElement = document.getElementById('error-message');
        
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setStatus('Failed to generate link', false);
        }
    }
    
    // Функция для отображения результата
    function showResult(link) {
        var resultContainer = document.getElementById('result-container');
        var resultLink = document.getElementById('result-link');
        
        if (resultContainer && resultLink) {
            sessionUrl = link;
            resultLink.href = link;
            resultLink.textContent = link;
            resultContainer.style.display = 'block';
            
            setStatus('Session link successfully generated!', false);
        }
    }
    
    // Функция для открытия ссылки в новом окне
    function openInNewTab() {
        if (sessionUrl) {
            window.open(sessionUrl, '_blank');
        }
    }
    
    // Функция для поиска ссылки в HTML
    function findLinkInHtml(html) {
        console.log("Got HTML response, length: " + html.length);
        console.log("HTML preview: " + html.substring(0, 200));
        
        // Попробуем найти ссылку по разным шаблонам
        var patterns = [
            /href=["']([^"']*\/room\/[^"']*)["'][^>]*>Session-wide demo link/i,
            /https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/join\/([a-z0-9]+)/i,
            /https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/room\/([a-z0-9]+)/i,
            /SessionStartLinks\/([a-z0-9]+)/i
        ];
        
        // Проверяем каждый шаблон
        for (var i = 0; i < patterns.length; i++) {
            var match = html.match(patterns[i]);
            if (match) {
                if (i === 0 && match[1]) { // Session-wide demo link
                    console.log("Found session link (pattern " + i + "): " + match[1]);
                    return match[1];
                } else if (i === 3 && match[1]) { // SessionStartLinks
                    var fullLink = "https://belabeu-e7061ee8ef78.herokuapp.com/SessionStartLinks/" + match[1];
                    console.log("Found session link (pattern " + i + "): " + fullLink);
                    return fullLink;
                } else if (match[0]) { // join or room links
                    console.log("Found session link (pattern " + i + "): " + match[0]);
                    return match[0];
                }
            }
        }
        
        // Если ничего не нашли, ищем любые URL
        var urlPattern = /https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/[a-z0-9\/\-_?=&]+/gi;
        var allUrls = html.match(urlPattern);
        
        if (allUrls && allUrls.length > 0) {
            console.log("Found URLs: ", allUrls);
            
            // Ищем наиболее подходящую ссылку
            for (var j = 0; j < allUrls.length; j++) {
                var url = allUrls[j];
                if (url.includes('/room/') || url.includes('/join/') || url.includes('SessionStartLinks')) {
                    console.log("Selected most relevant URL: " + url);
                    return url;
                }
            }
            
            // Если не нашли подходящую, берем первую
            console.log("Taking first URL found: " + allUrls[0]);
            return allUrls[0];
        }
        
        console.log("No links found in HTML");
        return null;
    }
    
    // Основная функция для генерации ссылки
    function generateExperimentLink() {
        console.log("Generate button clicked");
        
        // Сбрасываем UI
        var errorElement = document.getElementById('error-message');
        var resultContainer = document.getElementById('result-container');
        
        if (errorElement) errorElement.style.display = 'none';
        if (resultContainer) resultContainer.style.display = 'none';
        
        // Показываем состояние загрузки
        setStatus('Connecting to oTree server...', true);
        
        // Создаем AJAX-запрос
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1', true);
        
        // Обработчик ответа
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                console.log("Received response, status: " + xhr.status);
                
                // Ищем ссылку в HTML
                var link = findLinkInHtml(xhr.responseText);
                
                if (link) {
                    showResult(link);
                } else {
                    showError("Could not find session link in the response.");
                }
            } else {
                showError("Server returned error: " + xhr.status);
            }
        };
        
        // Обработчик ошибки
        xhr.onerror = function() {
            console.error("Network error occurred");
            showError("Network error occurred. CORS may be blocking the request.");
        };
        
        // Отправляем запрос
        try {
            xhr.send();
            console.log("Request sent to oTree server");
        } catch (error) {
            console.error("Error sending request:", error);
            showError("Error sending request: " + error.message);
        }
    }
    
    // Функция инициализации страницы
    function initPage() {
        console.log("Initializing page...");
        
        // Добавляем обработчики событий
        var generateButton = document.getElementById('generate-button');
        if (generateButton) {
            generateButton.addEventListener('click', generateExperimentLink);
            console.log("Added click handler to generate button");
        } else {
            console.error("Generate button not found!");
        }
        
        var openButton = document.getElementById('open-button');
        if (openButton) {
            openButton.addEventListener('click', openInNewTab);
            console.log("Added click handler to open button");
        } else {
            console.error("Open button not found!");
        }
        
        console.log("Page initialization complete");
    }
    
    // Инициализация страницы
    if (document.readyState === "complete" || document.readyState === "interactive") {
        // DOM уже загружен
        setTimeout(initPage, 1);
    } else {
        // DOM еще загружается
        document.addEventListener("DOMContentLoaded", initPage);
    }
    
    // Устанавливаем функции в глобальную область видимости для отладки
    window.otreeApp = {
        generateExperimentLink: generateExperimentLink,
        findLinkInHtml: findLinkInHtml,
        showResult: showResult,
        openInNewTab: openInNewTab
    };
    
    console.log("oTree experiment script loaded at " + new Date().toISOString());
})();
</script>
