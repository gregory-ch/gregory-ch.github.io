---
layout: single
title: "Experiment"
permalink: /experiment/
author_profile: true
---

<style>
body {
    overflow: auto;
}

.experiment-container {
    text-align: center;
    max-width: 800px;
    margin: 30px auto;
    padding: 30px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.experiment-button {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 15px 30px;
    margin: 20px 0;
    font-size: 18px;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: inline-block;
    text-decoration: none;
}

.experiment-button:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.success-button {
    background-color: #2ecc71;
}

.success-button:hover {
    background-color: #27ae60;
}

.info-block {
    background-color: #f8f9fa;
    border-left: 4px solid #3498db;
    padding: 20px;
    margin: 20px 0;
    font-size: 16px;
    line-height: 1.6;
    text-align: left;
}

.explanation {
    text-align: left;
    margin: 20px 0;
    line-height: 1.6;
}

#status {
    margin-top: 15px;
    padding: 10px;
    font-style: italic;
    color: #666;
}

.loading {
    display: inline-block;
    margin-left: 5px;
    animation: spin 1.5s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#experiment-iframe {
    width: 100%;
    height: 600px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-top: 20px;
    display: none;
}

#link-container {
    margin: 20px 0;
    padding: 15px;
    border: 2px dashed #3498db;
    border-radius: 6px;
    background-color: #f0f8ff;
    display: none;
}

.session-link {
    color: #2980b9;
    font-weight: bold;
    word-break: break-all;
    display: block;
    margin: 10px 0;
}

.tab-container {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
}

.tab {
    padding: 10px 20px;
    cursor: pointer;
    background-color: #f1f1f1;
    border: 1px solid #ddd;
    border-radius: 5px 5px 0 0;
    margin-right: 5px;
}

.tab.active {
    background-color: white;
    font-weight: bold;
    border-bottom: 2px solid #3498db;
}

.console-output {
    background-color: #2d2d2d;
    color: #f8f8f8;
    font-family: monospace;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    max-height: 300px;
    overflow: auto;
    text-align: left;
    display: none;
}

.console-line {
    margin: 5px 0;
    line-height: 1.5;
}

.console-error {
    color: #ff6b6b;
}

.console-success {
    color: #69db7c;
}

.console-info {
    color: #74c0fc;
}
</style>

<div class="experiment-container">
    <h2>oTree Experiment</h2>
    
    <div class="explanation">
        <p>This page allows you to access an oTree experiment hosted on Heroku. Click the button below to automatically generate a session link:</p>
    </div>
    
    <button id="generate-session" class="experiment-button">Generate Session Link</button>
    
    <div id="status"></div>
    
    <div id="link-container">
        <p>Your experiment session is ready:</p>
        <a id="session-link" href="#" target="_blank" class="session-link"></a>
        <button id="open-session" class="experiment-button success-button">Open in New Tab</button>
        <button id="embed-session" class="experiment-button">Load in Iframe Below</button>
    </div>
    
    <iframe id="experiment-iframe" src="about:blank"></iframe>
    
    <div class="info-block">
        <h3>How it works</h3>
        <p>When you click the button above:</p>
        <ol>
            <li>A request is sent to the oTree server to create a new experiment session</li>
            <li>The server response is analyzed to extract the session-wide link</li>
            <li>The session link is displayed for you to access the experiment</li>
        </ol>
    </div>
    
    <div class="tab-container">
        <div id="tab-normal" class="tab active">Normal View</div>
        <div id="tab-debug" class="tab">Debug View</div>
    </div>
    
    <div id="console-output" class="console-output">
        <div class="console-info console-line">// Debug information will appear here when you generate a session</div>
    </div>
</div>

<script>
// Utility function for logging
function log(message, type = 'info') {
    // Add to console output div
    const consoleOutput = document.getElementById('console-output');
    const lineElement = document.createElement('div');
    lineElement.className = `console-${type} console-line`;
    lineElement.textContent = message;
    consoleOutput.appendChild(lineElement);
    
    // Auto-scroll to bottom
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
    
    // Also log to browser console
    console[type] ? console[type](message) : console.log(message);
}

// Function to update status
function updateStatus(message, isLoading = false) {
    const statusEl = document.getElementById('status');
    
    if (isLoading) {
        statusEl.innerHTML = message + ' <span class="loading">‚ü≥</span>';
    } else {
        statusEl.textContent = message;
    }
    
    log(message);
}

// Function to extract session link from HTML
function extractSessionLink(html) {
    log('Analyzing response to find session link...', 'info');
    
    // Try different patterns to find links
    
    // First pattern: Session-wide demo link with href
    let pattern = /href=["']([^"']*\/room\/[^"']*)["'][^>]*>Session-wide demo link/i;
    let match = html.match(pattern);
    
    if (match && match[1]) {
        log(`Found session-wide demo link: ${match[1]}`, 'success');
        return match[1];
    }
    
    // Second pattern: join links
    pattern = /https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/join\/([a-z0-9]+)/i;
    match = html.match(pattern);
    
    if (match && match[0]) {
        log(`Found join link: ${match[0]}`, 'success');
        return match[0];
    }
    
    // Third pattern: room links
    pattern = /https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/room\/([a-z0-9]+)/i;
    match = html.match(pattern);
    
    if (match && match[0]) {
        log(`Found room link: ${match[0]}`, 'success');
        return match[0];
    }
    
    // Fourth pattern: Session start links
    pattern = /SessionStartLinks\/([a-z0-9]+)/i;
    match = html.match(pattern);
    
    if (match && match[1]) {
        const fullLink = `https://belabeu-e7061ee8ef78.herokuapp.com/SessionStartLinks/${match[1]}`;
        log(`Found session start link: ${fullLink}`, 'success');
        return fullLink;
    }
    
    log('No session link found in the response', 'error');
    return null;
}

// Function to retrieve session link
async function getSessionLink() {
    updateStatus('Requesting new session from oTree server...', true);
    log('Sending request to oTree server...', 'info');
    
    try {
        // Using XMLHttpRequest for better browser compatibility
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1', true);
            xhr.withCredentials = true; // Include cookies for CORS
            
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    log(`Received successful response (${xhr.status})`, 'success');
                    
                    // Extract session link from HTML response
                    const sessionLink = extractSessionLink(xhr.responseText);
                    
                    if (sessionLink) {
                        resolve(sessionLink);
                    } else {
                        // If automatic extraction fails, provide instructions for manual approach
                        log('Could not automatically extract session link', 'error');
                        log('Providing full response for direct access instead', 'info');
                        resolve('https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1');
                    }
                } else {
                    log(`Server returned error status: ${xhr.status}`, 'error');
                    reject(new Error(`Server responded with status ${xhr.status}`));
                }
            };
            
            xhr.onerror = function() {
                log('Network error occurred. This could be a CORS issue.', 'error');
                log('Checking if CORS is properly configured on the server side...', 'info');
                reject(new Error('Network error while connecting to oTree server'));
            };
            
            xhr.send();
        });
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
        updateStatus(`Error: ${error.message}. Please try again.`);
        throw error;
    }
}

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const generateButton = document.getElementById('generate-session');
    const openSessionButton = document.getElementById('open-session');
    const embedSessionButton = document.getElementById('embed-session');
    const tabNormal = document.getElementById('tab-normal');
    const tabDebug = document.getElementById('tab-debug');
    const consoleOutput = document.getElementById('console-output');
    
    // Generate session button
    generateButton.addEventListener('click', async function() {
        // Reset UI
        document.getElementById('link-container').style.display = 'none';
        document.getElementById('experiment-iframe').style.display = 'none';
        
        // Clear previous console output
        consoleOutput.innerHTML = '';
        log('Starting session generation process...', 'info');
        
        try {
            // Get session link
            const sessionLink = await getSessionLink();
            
            // Update UI with link
            updateStatus('Session link generated successfully!');
            document.getElementById('session-link').href = sessionLink;
            document.getElementById('session-link').textContent = sessionLink;
            document.getElementById('link-container').style.display = 'block';
            
            // Setup buttons for the link
            document.getElementById('open-session').onclick = function() {
                log(`Opening session in new tab: ${sessionLink}`, 'info');
                window.open(sessionLink, '_blank');
            };
            
            document.getElementById('embed-session').onclick = function() {
                log(`Loading session in iframe: ${sessionLink}`, 'info');
                const iframe = document.getElementById('experiment-iframe');
                iframe.src = sessionLink;
                iframe.style.display = 'block';
            };
        } catch (error) {
            updateStatus(`Error: ${error.message}. Please try again.`);
        }
    });
    
    // Tab switching
    tabNormal.addEventListener('click', function() {
        tabNormal.classList.add('active');
        tabDebug.classList.remove('active');
        consoleOutput.style.display = 'none';
    });
    
    tabDebug.addEventListener('click', function() {
        tabDebug.classList.add('active');
        tabNormal.classList.remove('active');
        consoleOutput.style.display = 'block';
    });
    
    // Log initial message
    log('Page loaded. Click "Generate Session Link" to start.', 'info');
});
</script>
