---
layout: single
title: "Experiment"
permalink: /experiment/
author_profile: true
---

<style>
body {
    overflow: auto;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.debug-info {
    position: fixed;
    bottom: 10px;
    right: 10px;
    padding: 10px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 12px;
    max-width: 300px;
    max-height: 200px;
    overflow: auto;
    z-index: 1001;
    border-radius: 5px;
    display: none;
}

.experiment-container {
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.experiment-button {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 15px 30px;
    margin: 20px 0;
    font-size: 18px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.experiment-button:hover {
    background-color: #2980b9;
}

.info-block {
    background-color: #f8f9fa;
    border-left: 4px solid #3498db;
    padding: 15px;
    margin: 20px 0;
    font-size: 16px;
    line-height: 1.6;
    text-align: left;
}

.explanation {
    text-align: left;
    margin: 20px 0;
    line-height: 1.6;
}
</style>

<div class="experiment-container">
    <h2>oTree Experiment</h2>
    
    <div class="explanation">
        <p>This page provides access to an experimental oTree study hosted on Heroku. Due to browser security policies (CORS), embedding the experiment directly in this page is not possible.</p>
    </div>
    
    <button id="startExperiment" class="experiment-button">Open Experiment in New Tab</button>
    
    <div class="info-block">
        <h3>What to expect:</h3>
        <p>When you click the button above, a new tab will open with the oTree demo page. On that page:</p>
        <ol>
            <li>Look for the "Session-wide demo link" option</li>
            <li>Click on that link to start the experiment</li>
            <li>The experiment will run in full screen in the new tab</li>
        </ol>
    </div>
    
    <div id="experimentPreview" style="display: none; margin-top: 20px;">
        <h3>Preview (if available):</h3>
        <iframe id="previewFrame" style="width: 800px; height: 600px; border: none; border-radius: 4px;"></iframe>
    </div>
</div>

<div style="text-align: center; padding: 20px;">
    <div id="frameContainer" style="height: 1400px; overflow: auto; position: relative; width: 800px; margin: 0 auto;">
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
            <p>Loading experiment...</p>
            <p id="status">Initialising connection to server...</p>
        </div>
        <iframe 
            id="experimentFrame"
            style="width: 800px; height: 2000px; border: none; border-radius: 4px; position: absolute; top: 0; left: 0;"
        ></iframe>
    </div>
    <div id="debugInfo" class="debug-info"></div>
</div>

<script>
// Включить режим отладки
const DEBUG = true;

// Функция для добавления отладочных сообщений
function debug(message) {
    if (DEBUG) {
        const debugInfo = document.getElementById('debugInfo');
        debugInfo.style.display = 'block';
        const timestamp = new Date().toLocaleTimeString();
        debugInfo.innerHTML += `<div>${timestamp}: ${message}</div>`;
        debugInfo.scrollTop = debugInfo.scrollHeight;
        console.log(`DEBUG: ${message}`);
    }
}

// Функция для извлечения session code
function extractSessionCode(text) {
    const match = text.match(/SessionStartLinks\/([a-z0-9]+)"/);
    if (match) {
        debug('Found session code: ' + match[1]);
        return match[1];
    }
    return null;
}

// Функция для поиска session-wide link на странице
function findSessionWideLink(html) {
    // Ищем ссылку формата https://belabeu-e7061ee8ef78.herokuapp.com/join/xxxxx
    // Более точное регулярное выражение для поиска
    const joinLinkMatch = html.match(/https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/join\/([a-z0-9]+)/);
    if (joinLinkMatch) {
        debug('Found session-wide link: ' + joinLinkMatch[0]);
        return joinLinkMatch[0];
    }
    return null;
}

// Функция для обновления статуса
function updateStatus(message) {
    const statusElement = document.getElementById('status');
    statusElement.textContent = message;
    debug('Status update: ' + message);
}

document.addEventListener('DOMContentLoaded', () => {
    debug('DOM loaded, starting experiment');
    
    const frame = document.getElementById('experimentFrame');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Инициализируем пустой iframe
    frame.src = "about:blank";
    
    // Задержка для наблюдения за интерфейсом oTree и клика по ссылке
    function tryClickSessionWideLink() {
        try {
            debug('Attempting to find and click session-wide link in iframe');
            const iframeDoc = frame.contentDocument || frame.contentWindow.document;
            
            // Проверяем все ссылки на странице
            const allLinks = iframeDoc.querySelectorAll('a');
            debug(`Found ${allLinks.length} links in iframe`);
            
            for (const link of allLinks) {
                debug(`Link text: "${link.textContent}", href: "${link.href}"`);
                
                // Проверяем ссылку на session-wide demo
                if (link.textContent.includes('Session-wide demo link') || 
                    link.href.includes('/join/') || 
                    link.parentElement.textContent.includes('Session-wide demo link')) {
                    debug('Found target link! Clicking...');
                    link.click(); // Имитируем клик по ссылке
                    updateStatus('Clicking on Session-wide demo link...');
                    return true;
                }
            }
            
            // Ищем конкретно по тексту на странице
            const sessionWideText = iframeDoc.body.innerHTML.indexOf('Session-wide demo link');
            if (sessionWideText > -1) {
                debug('Found Session-wide text but could not click link directly');
                
                // Извлекаем URL из HTML вокруг этого текста
                const htmlAroundLink = iframeDoc.body.innerHTML.substring(sessionWideText - 200, sessionWideText + 200);
                const extractedUrl = findSessionWideLink(htmlAroundLink);
                
                if (extractedUrl) {
                    debug('Extracted URL from HTML: ' + extractedUrl);
                    frame.src = extractedUrl;
                    return true;
                }
            }
            
            debug('Could not find or click session-wide link');
            return false;
        } catch (e) {
            debug('Error in tryClickSessionWideLink: ' + e.message);
            return false;
        }
    }
    
    // Функция для перехода к эксперименту
    function navigateToExperiment() {
        debug('Starting experiment navigation');
        
        // Сначала загружаем страницу с демо
        frame.src = 'https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1';
        updateStatus('Loading demo page...');
        
        // После загрузки фрейма пытаемся найти и кликнуть по нужной ссылке
        frame.onload = function() {
            debug('Demo page loaded in iframe');
            
            // Проверяем URL - если уже перешли к эксперименту, показываем его
            if (frame.src.includes('/join/') || frame.src.includes('SessionStartLinks')) {
                debug('Already redirected to experiment');
                updateStatus('Experiment loaded successfully');
                loadingOverlay.style.display = 'none';
                return;
            }
            
            // Пробуем найти ссылку в iframe и кликнуть по ней
            const clickSuccess = tryClickSessionWideLink();
            
            // Если не смогли кликнуть, пробуем альтернативный метод через fetch
            if (!clickSuccess) {
                debug('Click failed, trying fetch method');
                
                fetch('https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'text/html'
                    }
                })
                .then(response => {
                    debug('Fetch response status: ' + response.status);
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Fetch failed: ' + response.status);
                    }
                })
                .then(html => {
                    debug('Fetch response received, length: ' + html.length);
                    
                    // Ищем session-wide link в ответе
                    const sessionWideLink = findSessionWideLink(html);
                    
                    if (sessionWideLink) {
                        debug('Found session-wide link in fetch response');
                        updateStatus('Found experiment link, starting...');
                        frame.src = sessionWideLink;
                    } else {
                        debug('No session-wide link found in fetch response');
                        
                        // Если не нашли, пробуем извлечь session code
                        const sessionCode = extractSessionCode(html);
                        
                        if (sessionCode) {
                            debug('Found session code in fetch response');
                            updateStatus('Found session code, starting experiment...');
                            frame.src = `https://belabeu-e7061ee8ef78.herokuapp.com/SessionStartLinks/${sessionCode}`;
                        } else {
                            debug('No session code found either, setting manual timeout');
                            
                            // Если и это не помогло, устанавливаем таймаут для повторной попытки клика
                            setTimeout(() => {
                                debug('Timeout elapsed, trying click again');
                                if (!tryClickSessionWideLink()) {
                                    debug('All methods failed, showing demo page');
                                    loadingOverlay.style.display = 'none';
                                }
                            }, 2000);
                        }
                    }
                })
                .catch(error => {
                    debug('Fetch error: ' + error.message);
                    // В случае ошибки, просто оставляем демо страницу
                    loadingOverlay.style.display = 'none';
                });
            }
        };
    }
    
    // Запускаем навигацию к эксперименту
    navigateToExperiment();
    
    // Дополнительный обработчик загрузки iframe
    frame.addEventListener('load', () => {
        debug('Frame load event triggered: ' + frame.src);
        
        // Если страница загрузилась и это ссылка на эксперимент
        if (frame.src !== 'about:blank' && 
            (frame.src.includes('/join/') || 
             frame.src.includes('SessionStartLinks'))) {
            debug('Experiment URL detected, hiding overlay');
            updateStatus('Experiment loaded successfully');
            loadingOverlay.style.display = 'none';
                
            // Если это режим split screen, корректируем высоту
            if (frame.src.includes('SessionSplitScreen')) {
                debug('Split screen mode detected, adjusting height');
                frame.style.height = '1800px';
                frame.style.top = '-900.5px';
            }
        }
    });

    // Слушаем сообщения от iframe (для CORS коммуникации)
    window.addEventListener('message', function(event) {
        // Проверяем источник сообщения
        if (event.origin === "https://belabeu-e7061ee8ef78.herokuapp.com") {
            debug('Got message from iframe: ' + JSON.stringify(event.data));
            
            // Если получили URL или статус ready, скрываем оверлей загрузки
            if (event.data && (event.data.status === 'ready' || event.data.location)) {
                debug('Received ready status from iframe');
                loadingOverlay.style.display = 'none';
            }
        }
    });

    const startButton = document.getElementById('startExperiment');
    
    startButton.addEventListener('click', () => {
        // Открываем эксперимент в новой вкладке
        window.open('https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1', '_blank');
    });
    
    // Пробуем загрузить превью, но это может не сработать из-за CORS
    try {
        fetch('https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1', { 
            method: 'GET',
            mode: 'no-cors' // Это позволит запросу пройти, но ответ будет пустым из-за CORS
        })
        .then(response => {
            console.log('Preview request sent, but response might be empty due to CORS');
        })
        .catch(error => {
            console.log('Could not load preview:', error);
        });
    } catch(e) {
        console.log('Preview fetch failed:', e);
    }
});
</script> 