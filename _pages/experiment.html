---
layout: single
title: "Experiment"
permalink: /experiment/
author_profile: true
---

<style>
body {
    overflow: auto;
}

.experiment-container {
    text-align: center;
    max-width: 800px;
    margin: 30px auto;
    padding: 30px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.experiment-button {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 15px 30px;
    margin: 20px 0;
    font-size: 18px;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: inline-block;
    text-decoration: none;
}

.experiment-button:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.success-button {
    background-color: #2ecc71;
}

.success-button:hover {
    background-color: #27ae60;
}

.info-block {
    background-color: #f8f9fa;
    border-left: 4px solid #3498db;
    padding: 20px;
    margin: 20px 0;
    font-size: 16px;
    line-height: 1.6;
    text-align: left;
}

.explanation {
    text-align: left;
    margin: 20px 0;
    line-height: 1.6;
}

#status {
    margin-top: 15px;
    padding: 10px;
    font-style: italic;
    color: #666;
}

.loading {
    display: inline-block;
    margin-left: 5px;
    animation: spin 1.5s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#experiment-iframe {
    width: 100%;
    height: 600px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-top: 20px;
    display: none;
}

#link-container {
    margin: 20px 0;
    padding: 15px;
    border: 2px dashed #3498db;
    border-radius: 6px;
    background-color: #f0f8ff;
    display: none;
}

.session-link {
    color: #2980b9;
    font-weight: bold;
    word-break: break-all;
    display: block;
    margin: 10px 0;
}

.debug-panel {
    margin: 20px 0;
    padding: 15px;
    border: 2px solid #f39c12;
    border-radius: 6px;
    background-color: #fffaed;
    text-align: left;
    display: none;
}

.debug-button {
    background-color: #f39c12;
    margin: 10px 0;
}

.debug-button:hover {
    background-color: #e67e22;
}

.debug-actions {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.debug-download {
    background-color: #34495e;
}

.debug-download:hover {
    background-color: #2c3e50;
}

pre {
    background-color: #2d2d2d;
    color: #f8f8f8;
    font-family: monospace;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    max-height: 300px;
    overflow: auto;
    font-size: 14px;
}

.error-message {
    color: #e74c3c;
    font-weight: bold;
    padding: 10px;
    background-color: #fde2e2;
    border-radius: 4px;
    margin: 10px 0;
    display: none;
}
</style>

<div class="experiment-container">
    <h2>oTree Experiment</h2>
    
    <div class="explanation">
        <p>This page allows you to access an oTree experiment hosted on Heroku. Click the button below to automatically generate a session link:</p>
    </div>
    
    <button id="generate-button" class="experiment-button">Generate Session Link</button>
    
    <div id="status"></div>
    
    <div class="error-message" id="error-message"></div>
    
    <div id="link-container">
        <p>Your experiment session is ready:</p>
        <a id="session-link" href="#" target="_blank" class="session-link"></a>
        <button id="open-session" class="experiment-button success-button">Open in New Tab</button>
        <button id="embed-session" class="experiment-button">Load in Iframe Below</button>
    </div>
    
    <iframe id="experiment-iframe" src="about:blank"></iframe>
    
    <div class="info-block">
        <h3>How it works</h3>
        <p>When you click the button above:</p>
        <ol>
            <li>A request is sent to the oTree server to create a new experiment session</li>
            <li>The server response is analyzed to extract the session-wide link</li>
            <li>The session link is displayed for you to access the experiment</li>
        </ol>
    </div>
    
    <button id="toggle-debug" class="experiment-button debug-button">Show Debug Information</button>
    
    <div id="debug-panel" class="debug-panel">
        <h3>Debug Information</h3>
        <div class="debug-actions">
            <button id="xhr-test" class="experiment-button">Test XMLHttpRequest</button>
            <button id="fetch-test" class="experiment-button">Test Fetch API</button>
            <button id="download-logs" class="experiment-button debug-download">Download Debug Logs</button>
            <button id="clear-logs" class="experiment-button">Clear Logs</button>
        </div>
        <h4>Console Output:</h4>
        <pre id="debug-output">// Debug information will appear here</pre>
    </div>
</div>

<script>
// Немедленно выполняемая функция, не зависящая от DOMContentLoaded
(function() {
    // Переменная для хранения вывода отладки
    let debugLines = [];
    
    // Инициализируем лог
    console.log('Debug script started: ' + new Date().toISOString());

    // Проверка состояния DOM
    console.log('Document readyState: ' + document.readyState);
    console.log('Checking if elements exist...');
    
    // Проверяем наличие элементов
    const debugOutput = document.getElementById('debug-output');
    const generateButton = document.getElementById('generate-button');
    const toggleDebugButton = document.getElementById('toggle-debug');
    
    console.log('Debug output element exists: ' + !!debugOutput);
    console.log('Generate button exists: ' + !!generateButton);
    console.log('Toggle debug button exists: ' + !!toggleDebugButton);

    // Функция для добавления отладочной информации
    function debugLog(message, type = 'info') {
        const time = new Date().toLocaleTimeString();
        const logMessage = `[${time}] [${type.toUpperCase()}] ${message}`;
        
        // Добавить сообщение в массив
        debugLines.push(logMessage);
        
        // Ограничиваем количество сообщений для производительности
        if (debugLines.length > 100) {
            debugLines.shift();
        }
        
        // Обновляем вывод отладки
        const debugOutput = document.getElementById('debug-output');
        if (debugOutput) {
            debugOutput.textContent = debugLines.join('\n');
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
        
        // Всегда выводим в консоль для страховки
        console.log(`${time} [${type.toUpperCase()}] ${message}`);
        
        // Для ошибок и предупреждений дополнительно используем соответствующие методы консоли
        if (type === 'error') {
            console.error(message);
        } else if (type === 'warn') {
            console.warn(message);
        }
        
        // Возвращаем сообщение для возможности цепочки вызовов
        return message;
    }

    // Функция для показа сообщения об ошибке пользователю
    function showError(message) {
        const errorElement = document.getElementById('error-message');
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            debugLog(message, 'error');
        } else {
            console.error('Error element not found! Message: ' + message);
        }
    }

    // Функция для обновления статуса
    function updateStatus(message, isLoading = false) {
        const statusEl = document.getElementById('status');
        if (statusEl) {
            if (isLoading) {
                statusEl.innerHTML = message + ' <span class="loading">⟳</span>';
            } else {
                statusEl.textContent = message;
            }
            debugLog(message);
        } else {
            console.log('Status element not found! Message: ' + message);
        }
    }

    // Функция для извлечения ссылки на сессию из HTML
    function extractSessionLink(html) {
        debugLog('Analyzing response to find session link...');
        
        // Выводим часть HTML для отладки
        debugLog(`Response length: ${html.length} characters`);
        console.log('HTML response first 500 chars:', html.substring(0, 500));
        
        try {
            // Шаблон 1: Session-wide demo link с href атрибутом
            let pattern = /href=["']([^"']*\/room\/[^"']*)["'][^>]*>Session-wide demo link/i;
            let match = html.match(pattern);
            
            if (match && match[1]) {
                debugLog(`Found session-wide demo link: ${match[1]}`);
                return match[1];
            }
            
            // Шаблон 2: join ссылки
            pattern = /https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/join\/([a-z0-9]+)/i;
            match = html.match(pattern);
            
            if (match && match[0]) {
                debugLog(`Found join link: ${match[0]}`);
                return match[0];
            }
            
            // Шаблон 3: room ссылки
            pattern = /https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/room\/([a-z0-9]+)/i;
            match = html.match(pattern);
            
            if (match && match[0]) {
                debugLog(`Found room link: ${match[0]}`);
                return match[0];
            }
            
            // Шаблон 4: Session start ссылки
            pattern = /SessionStartLinks\/([a-z0-9]+)/i;
            match = html.match(pattern);
            
            if (match && match[1]) {
                const fullLink = `https://belabeu-e7061ee8ef78.herokuapp.com/SessionStartLinks/${match[1]}`;
                debugLog(`Found session start link: ${fullLink}`);
                return fullLink;
            }
            
            // Последний шанс - поиск любых URL
            debugLog('Desperate search for any URLs in response...');
            pattern = /https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/[a-z0-9\/\-_?=&]+/gi;
            const allUrls = html.match(pattern) || [];
            console.log('All URLs found:', allUrls);
            
            if (allUrls.length > 0) {
                const relevantUrl = allUrls.find(url => 
                    url.includes('/room/') || 
                    url.includes('/join/') || 
                    url.includes('SessionStartLinks')
                );
                
                if (relevantUrl) {
                    debugLog(`Found URL from desperate search: ${relevantUrl}`);
                    return relevantUrl;
                }
                
                // Если ничего подходящего - берем первый URL
                debugLog(`Taking first URL found: ${allUrls[0]}`);
                return allUrls[0];
            }
            
            debugLog('No URLs found in response!', 'error');
            return null;
        } catch (error) {
            console.error('Extract link error:', error);
            debugLog(`Error extracting link: ${error.message}`, 'error');
            return null;
        }
    }

    // Функция для получения ссылки на эксперимент через XHR
    function getExperimentLinkXHR() {
        console.log('Starting XHR request to oTree server...');
        
        // Сбрасываем UI
        const errorMessage = document.getElementById('error-message');
        if (errorMessage) errorMessage.style.display = 'none';
        
        // Обновляем статус
        updateStatus('Requesting session from oTree server...', true);
        
        // Создаем и настраиваем XHR
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1', true);
        
        // Обработчик загрузки
        xhr.onload = function() {
            console.log('XHR response received:', xhr.status);
            
            if (xhr.status >= 200 && xhr.status < 300) {
                // Успешный ответ
                console.log('Response received successfully');
                
                // Извлекаем ссылку
                const sessionLink = extractSessionLink(xhr.responseText);
                
                if (sessionLink) {
                    // Обновляем UI
                    updateStatus('Session link generated successfully!');
                    displaySessionLink(sessionLink);
                } else {
                    showError('Could not find session link in server response.');
                    updateStatus('Failed to find session link');
                }
            } else {
                showError(`Server error: ${xhr.status} ${xhr.statusText}`);
                updateStatus('Failed to get response from server');
            }
        };
        
        // Обработчик ошибки
        xhr.onerror = function() {
            console.error('XHR network error occurred');
            showError('Network error occurred. CORS may be blocking access.');
            updateStatus('Network error');
        };
        
        // Отправляем запрос
        try {
            xhr.send();
            console.log('XHR request sent');
        } catch (error) {
            console.error('Error sending XHR:', error);
            showError(`Error sending request: ${error.message}`);
        }
    }

    // Функция для отображения ссылки на сессию
    function displaySessionLink(link) {
        console.log('Displaying session link:', link);
        
        const linkContainer = document.getElementById('link-container');
        const sessionLink = document.getElementById('session-link');
        
        if (linkContainer && sessionLink) {
            sessionLink.href = link;
            sessionLink.textContent = link;
            linkContainer.style.display = 'block';
            
            // Настраиваем кнопки
            const openSession = document.getElementById('open-session');
            const embedSession = document.getElementById('embed-session');
            
            if (openSession) {
                openSession.onclick = function() {
                    console.log('Opening session in new tab');
                    window.open(link, '_blank');
                };
            }
            
            if (embedSession) {
                embedSession.onclick = function() {
                    console.log('Loading in iframe');
                    const iframe = document.getElementById('experiment-iframe');
                    if (iframe) {
                        iframe.src = link;
                        iframe.style.display = 'block';
                    }
                };
            }
        } else {
            console.error('Link container or session link element not found!');
            alert('Session link: ' + link);
        }
    }

    // Инициализация событий на кнопках
    function initializeEventHandlers() {
        console.log('Initializing event handlers...');
        
        // Кнопка генерации ссылки
        const generateButton = document.getElementById('generate-button');
        if (generateButton) {
            console.log('Adding click handler to generate button');
            generateButton.addEventListener('click', function() {
                console.log('Generate button clicked');
                getExperimentLinkXHR();
            });
        } else {
            console.error('Generate button not found!');
        }
        
        // Кнопка показа/скрытия отладки
        const toggleDebugButton = document.getElementById('toggle-debug');
        if (toggleDebugButton) {
            toggleDebugButton.addEventListener('click', function() {
                const debugPanel = document.getElementById('debug-panel');
                if (debugPanel) {
                    if (debugPanel.style.display === 'block') {
                        debugPanel.style.display = 'none';
                        toggleDebugButton.textContent = 'Show Debug Information';
                    } else {
                        debugPanel.style.display = 'block';
                        toggleDebugButton.textContent = 'Hide Debug Information';
                    }
                }
            });
        }
        
        // Делаем функции доступными глобально
        window.getExperimentLinkXHR = getExperimentLinkXHR;
        window.extractSessionLink = extractSessionLink;
        window.debugLog = debugLog;
    }

    // Запускаем инициализацию сразу
    initializeEventHandlers();
    console.log('Script initialization complete');
})();
</script>
