---
layout: single
title: "Experiment"
permalink: /experiment/
author_profile: true
---

<style>
body {
    overflow: auto;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<div style="text-align: center; padding: 20px;">
    <div id="frameContainer" style="height: 1400px; overflow: auto; position: relative; width: 800px; margin: 0 auto;">
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
            <p>Loading experiment...</p>
            <p id="status">Initialising connection to server...</p>
        </div>
        <iframe 
            id="experimentFrame"
            style="width: 800px; height: 2000px; border: none; border-radius: 4px; position: absolute; top: 0; left: 0;"
        ></iframe>
    </div>
</div>

<script>
// Функция для извлечения session code
function extractSessionCode(text) {
    const match = text.match(/SessionStartLinks\/([a-z0-9]+)"/);
    if (match) {
        console.log('Found session code:', match[1]);
        return match[1];
    }
    return null;
}

// Функция для поиска session-wide link на странице
function findSessionWideLink(html) {
    // Ищем ссылку формата https://belabeu-e7061ee8ef78.herokuapp.com/join/xxxxx
    const joinLinkMatch = html.match(/https:\/\/belabeu-e7061ee8ef78\.herokuapp\.com\/join\/([a-z0-9]+)/);
    if (joinLinkMatch) {
        console.log('Found session-wide link:', joinLinkMatch[0]);
        return joinLinkMatch[0];
    }
    return null;
}

// Функция для обновления статуса
function updateStatus(message) {
    const statusElement = document.getElementById('status');
    statusElement.textContent = message;
    console.log('Status update:', message);
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded');
    
    const frame = document.getElementById('experimentFrame');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Инициализируем пустой iframe
    frame.src = "about:blank";
    
    // Функция для перехода к эксперименту
    function navigateToExperiment() {
        // Сначала загружаем страницу с демо
        fetch('https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'text/html'
            }
        })
        .then(response => {
            if (response.ok) {
                updateStatus('Connected to server, finding experiment link...');
                return response.text();
            } else {
                updateStatus('Connection failed: ' + response.status);
                throw new Error('Connection failed');
            }
        })
        .then(html => {
            // Ищем session-wide link на странице
            const sessionWideLink = findSessionWideLink(html);
            
            if (sessionWideLink) {
                // Если нашли session-wide link, перенаправляем на него
                updateStatus('Found experiment link, starting...');
                frame.src = sessionWideLink;
            } else {
                // Если не нашли, пробуем извлечь session code
                const sessionCode = extractSessionCode(html);
                
                if (sessionCode) {
                    // Если нашли session code, пробуем использовать его
                    updateStatus('Found session code: ' + sessionCode);
                    frame.src = `https://belabeu-e7061ee8ef78.herokuapp.com/SessionStartLinks/${sessionCode}`;
                } else {
                    // Если ничего не нашли, просто загружаем демо страницу
                    updateStatus('Could not find direct link, loading demo page...');
                    frame.src = 'https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1';
                }
            }
        })
        .catch(error => {
            updateStatus('Error: ' + error.message);
            console.error('Error:', error);
            // В случае ошибки загружаем обычную демо страницу
            frame.src = 'https://belabeu-e7061ee8ef78.herokuapp.com/demo/dsst?test=1';
        });
    }
    
    // Запускаем навигацию к эксперименту
    navigateToExperiment();
    
    // Обработчик загрузки iframe
    frame.addEventListener('load', () => {
        // Если страница загрузилась успешно
        if (frame.src !== 'about:blank') {
            // Проверяем, содержит ли URL join или session, что указывает на успешное перенаправление
            if (frame.src.includes('/join/') || frame.src.includes('SessionStartLinks')) {
                updateStatus('Experiment loaded successfully');
                // Скрываем оверлей загрузки
                loadingOverlay.style.display = 'none';
                
                // Если это режим split screen, корректируем высоту
                if (frame.src.includes('SessionSplitScreen')) {
                    frame.style.height = '1800px';
                    frame.style.top = '-900.5px';
                }
            } else {
                // Если загруженная страница - это интерфейс oTree
                try {
                    const iframeDocument = frame.contentDocument || frame.contentWindow.document;
                    // Пытаемся найти session-wide link на загруженной странице
                    if (iframeDocument.body.innerHTML.includes('/join/')) {
                        const sessionWideLink = findSessionWideLink(iframeDocument.body.innerHTML);
                        if (sessionWideLink) {
                            updateStatus('Found session-wide link in loaded page, redirecting...');
                            frame.src = sessionWideLink;
                        } else {
                            // Пытаемся найти кнопку и кликнуть по ней
                            const links = iframeDocument.querySelectorAll('a');
                            for (const link of links) {
                                if (link.textContent.includes('Session-wide') || link.href.includes('/join/')) {
                                    updateStatus('Found session link, clicking...');
                                    link.click();
                                    return;
                                }
                            }
                            // Если не нашли ссылку, скрываем оверлей загрузки
                            loadingOverlay.style.display = 'none';
                        }
                    } else {
                        // Если не нашли ссылку, скрываем оверлей загрузки
                        loadingOverlay.style.display = 'none';
                    }
                } catch (e) {
                    // Cross-origin ошибка, просто скрываем оверлей загрузки
                    console.log('Cannot access iframe content due to same-origin policy:', e);
                    loadingOverlay.style.display = 'none';
                }
            }
        }
    });

    // Слушаем сообщения от iframe (для CORS коммуникации)
    window.addEventListener('message', function(event) {
        // Проверяем источник сообщения
        if (event.origin === "https://belabeu-e7061ee8ef78.herokuapp.com") {
            console.log('Got message from iframe:', event.data);
            
            // Если получили URL или статус ready, скрываем оверлей загрузки
            if (event.data && (event.data.status === 'ready' || event.data.location)) {
                loadingOverlay.style.display = 'none';
            }
        }
    });
});
</script> 